---
title: "Restaurant Data with Consumer Rating"
author: "Roman Mühlfeldner and Ana Stanusic"
output: html_notebook
---
# Data Science Project: Restaurant Data with Customer Rating

## Libraries

```{r}
library(plyr)
library(gplots)
library(RColorBrewer)
library(ggplot2)
library(ggmosaic)
library(ggrepel)
library(leaflet)
library(tidyverse)
library(corrplot)
```

## Aufgabenstellung:

* Datenaufbereitung [10%]
* Explorative Datenanalyse, speziell Visualisierung [20%]
* Modellierung (Klassifikation oder Regression) mit zumindest 3 Methoden, inkl. Parameter Tuning und Benchmarking [30%]
* Deployment des besten Modells mittels Web Service [10%]
* Kurzpräsentation des Projekts/der Ergebnisse mittels Dashboard [10%]
* Extra-Feature - zB neue Methoden, interaktive Visualisierung [20%]
* Dokumentation mittels Notebook

## Datenaufbereitung

Daten einlesen:

```{r}
accept <- read.csv('./data/chefmozaccepts.csv')
cuisine <- read.csv('./data/chefmozcuisine.csv')
hours <- read.csv('./data/chefmozhours4.csv')
parking <- read.csv('./data/chefmozparking.csv')
geoplaces <- read.csv('./data/geoplaces2.csv', na.strings = "?")
rating <- read.csv('./data/rating_final.csv')
usercuisine <- read.csv('./data/usercuisine.csv')
userpayment <- read.csv('./data/userpayment.csv')
userprofile <- read.csv('./data/userprofile.csv', na.strings = "?")
```

Die Daten bestehen aus verschiedenen Datensätzen, die von Restaurants in Mexiko stammen. 
Grundsätzlich sind die Daten in drei Gruppen zu unterteilen:
  1. Restaurant-Sicht (inklusive den Geo-Daten)
  2. Kunden-Sicht
  3. Rating vom Kunden des Restaurant


## Datenanalyse

### Restaurant-Daten

```{r}
head(accept)
dim(accept)
summary(accept)
levels(accept$Rpayment)
ggplot(accept, aes(x = Rpayment, fill=Rpayment)) + geom_bar()
```

Aufgrund der Anzahl der verschiedenen Kreditkarten ist die Anzahl der Zahlungsmethoden mit 12 Ausprägungen zu hoch. Aus diesem Grund werden die verschiedenen Kreditkarten zusammengefasst.
Einfachheitshalber werden zusätzlich noch Carte_blanche und checks zusammengefasst.

```{r}
accept$Rpayment = revalue(accept$Rpayment, c("American_Express"="credit_card", "MasterCard-Eurocard"="credit_card", "Visa"="credit_card", "VISA"="credit_card", "Diners_Club"="credit_card", "Japan_Credit_Bureau"="credit_card", "Discover"="credit_card"))

accept$Rpayment = revalue(accept$Rpayment, c("Carte_Blanche"="checks", "checks"="checks"))

ggplot(accept, aes(x = Rpayment, fill=Rpayment)) + geom_bar()
```

```{r}
head(cuisine)
dim(cuisine)
levels(cuisine$Rcuisine)
summary(cuisine)
ggplot(cuisine, aes(x = Rcuisine, fill=Rcuisine)) + geom_bar()
```
Die kategoriale Varible Rcuisine hat 59 Ausprägungen. Aus diesem Grund müssen diese zusammengefasst werden. Zusammengefasst werden die Ausprägungen nach den Regionen.
* Persian
* Asia
* American
* European
* South_American
* African
* International

```{r}
cuisine$Rcuisine = revalue(cuisine$Rcuisine, c("Japanese"="Asian", "Chinese"="Asian",
                                               "Sushi"="Asian", "Korean"="Asian",
                                               "Mongolian"="Asian", "Thai"="Asian",
                                               "Asia"="Asian", "Vietnamese"="Asian",
                                               "Deli-Sandwiches"="Asian"))

cuisine$Rcuisine = revalue(cuisine$Rcuisine, c("Dutch-Belgian"="European",
                                               "Continental-European"="European",
                                               "Eastern_European"="European",
                                               "Greek"="European",
                                               "Spanish"="European", "French"="European",
                                               "German"="European", "Italian"="European",
                                               "Polish"="European", "Pizzeria"="European",
                                               "Dessert-Ice_Cream"="European", 
                                               "Seafood"="European"))

cuisine$Rcuisine = revalue(cuisine$Rcuisine, c("Ethiopian"="African",
                                               "African"="African"))

cuisine$Rcuisine = revalue(cuisine$Rcuisine, c("Barbecue"="American",
                                               "Hot_Dogs"="American",
                                               "Steaks"="American",
                                               "American"="American",
                                               "Fast_Food"="American",
                                               "Burgers"="American",
                                               "California"="American",
                                               "Southwestern"="American",
                                               "Game"="American",
                                               "Diner"="American"))

cuisine$Rcuisine = revalue(cuisine$Rcuisine, c("Persian"="Persian",
                                               "Mediterranean"="Persian",
                                               "Turkish"="Persian",
                                               "Afghan"="Persian",
                                               "Armenian"="Persian"))

cuisine$Rcuisine = revalue(cuisine$Rcuisine, c("Brazilian"="South_American",
                                               "Caribbean"="South_American",
                                               "Southern"="South_American",
                                               "Mexican"="South_American",
                                               "Latin_American"="South_American"))

cuisine$Rcuisine = revalue(cuisine$Rcuisine, c("Bar"="International",
                                               "Contemporary"="International",
                                               "Fine_Dining"="International",
                                               "Vegetarian"="International",
                                               "Bakery"="International",
                                               "Cafe-Coffee_Shop"="International",
                                               "Organic-Healthy"="International",
                                               "Juice"="International",
                                               "Soup"="International",
                                               "Bagels"="International",
                                               "Bar_Pub_Brewery"="International",
                                               "Breakfast-Brunch"="International",
                                               "Cafeteria"="International",
                                               "Family"="International",
                                               "Regional"="International"))


levels(cuisine$Rcuisine)
```

```{r}
ggplot(cuisine, aes(x = Rcuisine, fill=Rcuisine)) + geom_bar()
```


```{r}
head(hours)
dim(hours)
summary(hours)
#levels(hours$hours)
#ggplot(hours, aes(x = days, fill=hours)) + geom_bar()
```

Für die weitere Ausarbeitung werden die Öffnungszeiten nicht weiter berücksichtigt, da eine Gruppierung auf wenige Ausprägungen sich schwierig darstellt und somit für vorhersagen schwer zu verwenden ist.

```{r}
head(parking)
dim(parking)
summary(parking)
ggplot(parking, aes(x = parking_lot, fill=parking_lot)) + geom_bar()
```

Die Parkplatzinformationen werden gruppiert nach ja und nein.

```{r}
parking_grouped <- parking
parking_grouped$parking_lot = revalue(parking_grouped$parking_lot, c("fee"="yes", "public"="yes", "street"="yes", "valet parking"="yes", "validated parking"="yes"))
ggplot(parking_grouped, aes(x = parking_lot, fill=parking_lot), ) + geom_bar() + coord_flip()
```


```{r}
head(geoplaces)
dim(geoplaces)
summary(geoplaces)
```

```{r}
m <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=geoplaces$longitude, lat=geoplaces$latitude, popup=geoplaces$name)
m  # Print the map
```

### Kunden-Daten

```{r}
head(usercuisine)
dim(usercuisine)
summary(usercuisine)
levels(usercuisine$Rcuisine)
```

Um die Ausprägungen der Rcuisine zu reduzieren werden die gleichen Levels wie obrig verwendet.

```{r}
usercuisine$Rcuisine = revalue(usercuisine$Rcuisine, c("Japanese"="Asian", "Chinese"="Asian",
                                               "Sushi"="Asian", "Korean"="Asian",
                                               "Mongolian"="Asian", "Thai"="Asian",
                                               "Asia"="Asian", "Vietnamese"="Asian",
                                               "Deli-Sandwiches"="Asian",
                                               "Southeast_Asian"="Asian",
                                               "Burmese"="Asian", "Cambodian"="Asian", 
                                               "Malaysian"="Asian", "Dim_Sum"="Asian", "Indonesian"="Asian"))

usercuisine$Rcuisine = revalue(usercuisine$Rcuisine, c("Dutch-Belgian"="European",
                                               "Continental-European"="European",
                                               "Eastern_European"="European",
                                               "Greek"="European",
                                               "Spanish"="European", "French"="European",
                                               "German"="European", "Italian"="European",
                                               "Polish"="European", "Pizzeria"="European",
                                               "Dessert-Ice_Cream"="European", 
                                               "Seafood"="European",
                                               "British"="European",
                                               "Irish"="European",
                                               "Swiss"="European",
                                               "Filipino"="European", "Austrian"="European", "Hungarian"="European",
                                               "Portuguese"="European", "Romanian"="European", "Basque"="European",
                                               "Scandinavian"="European", "Russian-Ukrainian"="European"))

usercuisine$Rcuisine = revalue(usercuisine$Rcuisine, c("Ethiopian"="African",
                                               "African"="African",
                                               "North_African"="African",
                                               "Israeli"="African",
                                               "Jamaican"="African", "Lebanese"="African", "Tibetan"="African", "Tunisian"="African", 
                                               "Middle_Eastern"="African", "Moroccan"="African"))

usercuisine$Rcuisine = revalue(usercuisine$Rcuisine, c("Barbecue"="American",
                                               "Hot_Dogs"="American",
                                               "Steaks"="American",
                                               "American"="American",
                                               "Fast_Food"="American",
                                               "Burgers"="American",
                                               "California"="American",
                                               "Southwestern"="American",
                                               "Game"="American",
                                               "Diner"="American",
                                               "Doughnuts"="American",
                                               "Pacific_Northwest"="American",
                                               "Cajun-Creole"="American",
                                               "Pacific_Rim"="American",
                                               "Canadian"="American",
                                               "Hawaiian"="American", "Indigenous"="American"))

usercuisine$Rcuisine = revalue(usercuisine$Rcuisine, c("Persian"="Persian",
                                               "Mediterranean"="Persian",
                                               "Turkish"="Persian",
                                               "Afghan"="Persian",
                                               "Armenian"="Persian",
                                               "Indian-Pakistani"="Persian"))

usercuisine$Rcuisine = revalue(usercuisine$Rcuisine, c("Brazilian"="South_American",
                                               "Caribbean"="South_American",
                                               "Southern"="South_American",
                                               "Mexican"="South_American",
                                               "Latin_American"="South_American", "Peruvian"="South_American",
                                               "Tapas"="South_American", "Tex-Mex"="South_American",
                                               "Chilean"="South_American", "Cuban"="South_American"))

usercuisine$Rcuisine = revalue(usercuisine$Rcuisine, c("Bar"="International",
                                               "Contemporary"="International",
                                               "Fine_Dining"="International",
                                               "Vegetarian"="International",
                                               "Bakery"="International",
                                               "Cafe-Coffee_Shop"="International",
                                               "Organic-Healthy"="International",
                                               "Juice"="International",
                                               "Soup"="International",
                                               "Bagels"="International",
                                               "Bar_Pub_Brewery"="International",
                                               "Breakfast-Brunch"="International",
                                               "Cafeteria"="International",
                                               "Family"="International",
                                               "Regional"="International",
                                               "Eclectic"="International", "Fusion"="International",
                                               "Tea_House"="International", 
                                               "Australian"="International",
                                               "Kosher"="International", "Polynesian"="International"))


levels(usercuisine$Rcuisine)
```

```{r}
ggplot(usercuisine, aes(x = Rcuisine, fill=Rcuisine)) + geom_bar()
```


```{r}
head(userpayment)
dim(userpayment)
summary(userpayment)
ggplot(userpayment, aes(x = Upayment, fill=Upayment)) + geom_bar()
```

Auch bei den Zahlungsmethoden werden die Kreditkarten wie obrig zusammengefasst.

```{r}
userpayment$Upayment = revalue(userpayment$Upayment, c("American_Express"="credit_card", "MasterCard-Eurocard"="credit_card", "VISA"="credit_card"))
ggplot(userpayment, aes(x = Upayment, fill=Upayment)) + geom_bar()
```

```{r}
head(userprofile)
dim(userprofile)
summary(userprofile)
ggplot(userprofile) + geom_mosaic(aes(product(smoker,drink_level), fill = smoker))
```

### Rating

```{r}
head(rating)
dim(rating)
summary(rating)
ggplot(rating, aes(food_rating, service_rating)) +  
  geom_smooth(method = "lm")
```

## Explorative Datenanalyse, speziell Visualisierung [20%]

### Restaurant Data

Eigenheiten der Restaurants

```{r}
cuisine_detail <- cuisine %>% 
  join(geoplaces)

cuisine_detail <- cuisine_detail %>% 
  filter(!is.na(name)) %>%
  select(placeID, name, Rcuisine, alcohol, smoking_area, dress_code, accessibility, price, Rambience)

cuisine_detail 
```

Überblick über einzelne Ausprägungen in den Bereichen Alcohol, Smoking und Price

```{r}
# Generating Distribution Tables
## Alcohol
cuisine_detail_dist_alc<- cuisine_detail %>% 
  distinct(Rcuisine, alcohol)

cuisine_detail_dist_alc <- gather(cuisine_detail_dist_alc, key, value, -Rcuisine) %>% 
  count(Rcuisine, value) %>% 
  spread(value, n, fill = 0) %>% 
  group_by(Rcuisine) %>% 
  rename(Alc_Full_Bar = Full_Bar, Alc_No_Alcohol_Served = No_Alcohol_Served, Alc_Wine_Beer = "Wine-Beer")

cuisine_detail_dist_alc

## Smoking
cuisine_detail_dist_smoking<- cuisine_detail %>% 
  distinct(Rcuisine, smoking_area)

cuisine_detail_dist_smoking <- gather(cuisine_detail_dist_smoking, key, value, -Rcuisine) %>% 
  count(Rcuisine, value) %>% 
  spread(value, n, fill = 0) %>% 
  group_by(Rcuisine) %>% 
  rename(smoking_not_permitted = "not permitted", smoking_only_at_bar = "only at bar", smoking_none = none, smoking_section = section, smoking_permitted = permitted)

cuisine_detail_dist_smoking

## Price
cuisine_detail_dist_price<- cuisine_detail %>% 
  distinct(Rcuisine, price)

cuisine_detail_dist_price <- gather(cuisine_detail_dist_price, key, value, -Rcuisine) %>% 
  count(Rcuisine, value) %>% 
  spread(value, n, fill = 0) %>% 
  group_by(Rcuisine) %>% 
  rename(price_low = low, price_medium = medium, price_high = high) 

cuisine_detail_dist_price

# JOINING TABLES

dt_dist <- cbind(cuisine_detail_dist_alc, cuisine_detail_dist_smoking, cuisine_detail_dist_price)
dt_dist$Rcuisine1 <- NULL
dt_dist$Rcuisine2 <- NULL
dt <- column_to_rownames(dt_dist, 'Rcuisine')
dt <- as.table(as.matrix(dt))
dt

balloonplot(t(dt), main ="Distribution Smoking, Alcohol, Pricing Grouped By the Cuisines", xlab ="", ylab="",
            label = FALSE, show.margins = FALSE, colsrt=90, rowmar=5, colmar=10)
```

Chi-Squared Tests um Zusammenhänge der Variablen zu erkennen.
Dafür wird zunächst eine Distribution Table erzeugt mit den Variablen: alcohol, smoking_area, price gruppiert nach Rcuisine.
#!!! NOCH NICHT DAS RICHTIGE
```{r}
chisq <- chisq.test(dt)
corrplot(chisq$residuals, is.cor = FALSE)
```

### Kunden Data
Bewertugen der Places mit cuisine und name

```{r}
user_detail <- userprofile %>% 
  join(usercuisine) %>% 
  join(userpayment)

user_detail
```

Standort der Kunden und der Restaurants

```{r}
customers = makeIcon("user_icon.png", 50, 50)
restaurants = makeIcon("restaurant_icon.png", 50, 50)
m <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=userprofile$longitude, lat=userprofile$latitude, popup=userprofile$userID, icon = customers) %>% 
  addMarkers(lng = geoplaces$longitude, lat = geoplaces$latitude, icon = restaurants, popup = geoplaces$name)
m  # Print the map
```

Einfluss von dem Trinkverhalten auf das Budget.

```{r}
ggplot(user_detail) + geom_mosaic(aes(product(drink_level,budget), fill = drink_level))
```

```{r}
user_detail
ggplot(user_detail) + geom_mosaic(aes(product(drink_level,budget), fill = drink_level)) + facet_wrap(.~Rcuisine, ncol=2)
```

### Rating Data

Bewertugen der Places mit cuisine und name

```{r}
head(rating)

rating_detailed <- rating %>% 
  inner_join(cuisine) %>% 
  inner_join(geoplaces) %>%
  arrange(placeID) %>% 
  select(placeID, rating, food_rating, service_rating, name, Rcuisine)

rating_detailed %>% 
  group_by(placeID, name, Rcuisine) %>% 
  summarize(rating = mean(rating),
            food_rating = mean(food_rating),
            service_rating = mean(food_rating))
```

```{r}
ggplot(rating_detailed) + aes(food_rating, service_rating, col = Rcuisine) +  
  geom_smooth(method = "lm", se=F) + ggtitle("Relation Food Rating and Service Rating Grouped By Cuisine")
```


## Modellierung (Klassifikation oder Regression) mit zumindest 3 Methoden, inkl. Parameter Tuning und Benchmarking [30%]

Für die Modelle wird das Rating vorhergesagt aufgrund der Prädiktoren Cuisine, smoker, budget, drinking_level.
Als Methoden wurden Rpart, RandomForest, NaiveBayes und KNN gewählt, die miteinander verglichen werden.

### Vorbereitung der Daten

Data Values

```{r}

```

Scaling

```{r}

```

Tunen

```{r}

```

Fitten

```{r}

```

Predict

```{r}

```


## Deployment des besten Modells mittels Web Service [10%]

## Kurzpräsentation des Projekts/der Ergebnisse mittels Dashboard [10%]
 
## Extra-Feature - zB neue Methoden, interaktive Visualisierung [20%]
